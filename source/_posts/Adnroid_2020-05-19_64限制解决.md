---
title: æˆ‘æ˜¯å¦‚ä½•ä¸€æ­¥ä¸€æ­¥çˆ¬ä¸Š â€œ64Ké™åˆ¶â€ çš„å‘ ï½œ ç»éªŒè´´
layout: post
date: 2020-05-20
comments: true
categories: Android
tags: [æºç ]
---

<!--more-->

### åˆè¡·

åˆ†äº«è¿™ä¸ªå¡«å‘çš„è®°å½•ï¼Œä¸»è¦æ˜¯æ„Ÿè§‰èº«è¾¹å¾ˆå¤š Androider éƒ½ä¼šé‡åˆ°å’Œæˆ‘ä¸€æ ·çš„åœºæ™¯ã€‚

1. é‡åˆ°ä¸€ä¸ª BUG ï¼Œä¼˜å…ˆæŒ‰ç…§è‡ªå·±ç»éªŒä¿®å¤
2. ä¿®å¤ä¸äº†äº†ï¼Œå¼€å§‹ Googleï¼ˆä¸è¦ç™¾åº¦ï¼Œå†ä¸‰å¼ºè°ƒï¼‰ï¼Œå¯»æ‰¾ä¸€åˆ‡å’Œæˆ‘ä»¬ BUG ç›¸ä¼¼çš„é—®é¢˜ï¼Œç„¶åçœ‹çœ‹æœ‰æ²¡æœ‰è§£å†³æ–¹æ¡ˆ
3. å°è¯•äº†å¾ˆå¤šè§£å†³æ–¹æ¡ˆï¼Œa æ–¹æ¡ˆä¸è¡Œæ¢ b æ–¹æ¡ˆï¼Œb æ–¹æ¡ˆä¸è¡Œæ¢ c æ–¹æ¡ˆ... çŸ¥é“æ²¡æœ‰æ–¹æ¡ˆå¯ä»¥å°è¯•äº†ï¼Œå¼€å§‹ç»æœ›...
4. å¦‚æœå½±å“ä¸å¤§ï¼Œé‚£å°±ä¸¢åœ¨é¡¹ç›®é‡Œï¼ˆä¼°è®¡ä¹Ÿæ²¡äººå‘ç°ï¼‰ï¼Œå¦‚æœå½±å“å¾ˆå¤§ï¼Œé‚£åªèƒ½å¯»æ‰¾åˆ«äººå¸®åŠ©ï¼Œå¦‚æœåˆ«äººä¹Ÿç»™ä¸äº†å»ºè®®ï¼Œé‚£å°±åŸåœ°ğŸ’¥ 

å…¶å®æ— è®ºå½±å“å¤§ä¸å¤§ï¼Œä¸¢åœ¨é¡¹ç›®é‡Œæ€»ä¸å¤ªå¥½ã€‚ å½“åˆ«äººå¸®åŠ©ä¸äº†çš„æ—¶å€™ï¼ŒçœŸçš„å°±åªæœ‰ä»£ç èƒ½å¸®ä½ ã€‚å°è¯•è¿‡å¾ˆå¤šæ–¹æ¡ˆä¸å¯è¡Œï¼Œå¾ˆå¤šæ—¶å€™æ˜¯å› ä¸ºæ¯ä¸ªæ–¹æ¡ˆçš„èƒŒæ™¯ä¸ä¸€æ ·ï¼ŒåŒ…æ‹¬å¼€å‘ç¯å¢ƒèƒŒæ™¯å¦‚ gradle ç‰ˆæœ¬ï¼Œç¼–è¯‘ç‰ˆæœ¬ ï¼Œapi ç‰ˆæœ¬ç­‰ã€‚æˆ‘é‡åˆ°çš„è¿™ä¸ªé—®é¢˜ä¹Ÿæ˜¯å¦‚æ­¤ã€‚ 

å¸Œæœ›é€šè¿‡ä»¥ä¸‹çš„è®°å½•èƒ½å¸®åŠ©ä½ åœ¨é¢å¯¹æ— èƒ½ä¸ºåŠ›çš„ â€œBUGâ€ æ—¶æ›´åšå®šåœ°å¯»æ‰¾è§£å†³æ–¹æ¡ˆã€‚

### èƒŒæ™¯

> åœ¨æˆ‘ä»¬é¡¹ç›®æœ€è¿‘çš„ä¸€ä¸ªç‰ˆæœ¬ä¸­ï¼ŒQA æµ‹è¯• feature åŠŸèƒ½æ—¶åé¦ˆ â€œ4.4è®¾å¤‡ä¸Šï¼ŒAPP éƒ½ crash å•¦ï¼â€ ç”±äºåé¦ˆè¯¥é—®é¢˜çš„æ—¶å€™å·²ç»å¿«å‘¨æœ«äº†ï¼ŒæŒ‰ç…§ PM çš„æµç¨‹æˆ‘ä»¬éœ€è¦åœ¨ä¸‹å‘¨ä¸€å°åŒ…ç»™ MTL åšè´¨é‡æµ‹è¯•ï¼Œè¿™ä¸ªé—®é¢˜å¿…é¡»åœ¨å‘¨ä¸€å‰è§£å†³ã€‚ =ã€‚=

ç¬¬ä¸€ååº” â€œGGï¼Œæ„Ÿè§‰åº”è¯¥æ˜¯å‘â€ã€‚ç«‹åˆ»å€Ÿäº†ä¸¤å° 4.4 çš„æœºå‹å¯¹å‘ç”Ÿ Crash çš„åŒ…ä½“è¿›è¡Œè°ƒè¯•ï¼Œå‘ç°éƒ½æ˜¯ â€œjava.lang.NoClassDefFoundErrorâ€ã€‚ è¿™ä¸ªcrashè¡¨æ˜æ‰¾ä¸åˆ°å¼•ç”¨çš„ç±»åŸæœ¬åº”è¯¥åœ¨ ä¸» Dex æ–‡ä»¶ä¸­ï¼Œä½†æ˜¯ä¸» Dex æ–‡ä»¶ä¸­å´æ²¡æœ‰æä¾›è¿™ä¸ªç±»ã€‚

éš¾é“æˆ‘ä»¬æ²¡æœ‰ keep ä½è¿™ä¸ªç±»å—ï¼Ÿ ä¸åº”è¯¥å•Šï¼Œæ˜¾ç„¶æ˜¯å› ä¸ºæ„å»ºå·¥å…·å·²ç»çŸ¥é“è¿™ä¸ªç±»åº”è¯¥è¢«æ‰“è¿›å»ï¼Œå´å› ä¸ºæŸäº›åŸå› æ²¡æœ‰è¢«æ‰“è¿›å»ã€‚æˆ‘å°è¯•ä½¿ç”¨ mutilDexKeepProguard keep ä½è¿™ä¸ªç±»ï¼Œç„¶åç¼–è¯‘ç›´æ¥ä¸é€šè¿‡äº†ã€‚æ”¶åˆ°çš„å¼‚å¸¸ä¸ºï¼š

```
D8: Cannot fit requested classes in the main-dex file (# methods: 87855 > 65536 ; # fields: 74641 > 65536)
```

### å®šä½é—®é¢˜

ä¸Šè¿°å¼‚å¸¸ä½ å¯èƒ½å¾ˆç†Ÿæ‚‰ã€‚ Dex æ–‡ä»¶è§„èŒƒæ˜ç¡®æŒ‡å‡ºï¼Œå•ä¸ª dex æ–‡ä»¶å†…å¼•ç”¨çš„æ–¹æ³•æ€»æ•°åªèƒ½ä¸º 65536ï¼Œè€Œè¿™ä¸ªé™åˆ¶æ¥æºäºæ˜¯ davilk æŒ‡ä»¤ä¸­è°ƒç”¨æ–¹æ³•çš„å¼•ç”¨ç´¢å¼•æ•°å€¼ï¼Œè¯¥æ•°å€¼é‡‡ç”¨ 16ä½ äºŒè¿›åˆ¶è®°å½•ï¼Œä¹Ÿå°±æ˜¯ 2^16 = 65536ã€‚ è¿™äº›æ–¹æ³•æ•°åŒ…æ‹¬äº† Android Framework å±‚æ–¹æ³•ï¼Œç¬¬ä¸‰æ–¹åº“æ–¹æ³•åŠåº”ç”¨ä»£ç æ–¹æ³•ã€‚


æ‰€è°“ ä¸»dexï¼Œå…¶å®å°±æ˜¯ classes.dexã€‚è¿˜å¯èƒ½å­˜åœ¨ classes1.dex,classes2.dex...classesN.dexï¼Œå› ä¸ºå®Œæ•´çš„é¡¹ç›®å¯èƒ½åŒ…å«è¶…è¿‡ 65536 ä¸ªæ–¹æ³•ï¼Œå› ä¸ºéœ€è¦å¯¹é¡¹ç›®çš„ class è¿›è¡Œåˆ‡åˆ†ã€‚ä¸»dexä¼šè¢«æœ€å…ˆåŠ è½½ï¼Œå¿…é¡»åŒ…å«å¯åŠ¨å¼•ç”¨æ‰€éœ€è¦çš„ç±»åŠâ€œä¾èµ–ç±»â€ï¼ˆåé¢ä¼šæœ‰è¯¦ç»†ä»‹ç»ï¼‰ã€‚è€Œæˆ‘æ‰€é‡åˆ°çš„é—®é¢˜å°±æ˜¯ â€œåŒ…å«å¯åŠ¨å¼•ç”¨æ‰€éœ€è¦çš„ç±»åŠâ€œä¾èµ–ç±»åŒ…å«çš„æ–¹æ³•æ•°â€ è¶…è¿‡ 65536 ä¸ªï¼Œæ„å»ºç³»ç»Ÿä¸ç»™æˆ‘ç»§ç»­æ„å»ºäº†ã€‚ 

äº‹å®ä¸Šï¼Œåœ¨ minsdkVersion >= 21 çš„åº”ç”¨ç¯å¢ƒä¸‹æ˜¯ä¸ä¼šå‡ºç°è¿™ç§å¼‚å¸¸çš„ã€‚å› ä¸ºæ„å»ºapkæ—¶æ–¹æ³•æ•°è™½ç„¶è¶…è¿‡ 65536å¿…é¡»åˆ†åŒ…å¤„ç†å¤§ï¼Œä½†ç”±äºä½¿ç”¨ ART è¿è¡Œçš„è®¾å¤‡åœ¨åŠ è½½ apk æ—¶ä¼šåŠ è½½å¤šä¸ªdexæ–‡ä»¶ï¼Œåœ¨å®‰è£…æ—¶æ‰§è¡Œé¢„ç¼–è¯‘ï¼Œæ‰«æ classesN.dex æ–‡ä»¶ï¼Œå¹¶æŠŠä»–ä»¬ç¼–è¯‘æˆå•ä¸ª.oat æ–‡ä»¶ã€‚æ‰€ä»¥ â€œåŒ…å«å¯åŠ¨å¼•ç”¨æ‰€éœ€è¦çš„ç±»åŠâ€œä¾èµ–ç±»â€  å¯ä»¥æ•£è½åœ¨ä¸åŒçš„ dex æ–‡ä»¶ä¸Šã€‚

ä½†æ˜¯ minsdkVersion < 21 å°±ä¸ä¸€æ ·äº†ï¼Œ5.0ä»¥ä¸‹çš„æœºå‹ç”¨çš„æ˜¯ Dalvik è™šæ‹Ÿæœºï¼Œåœ¨å®‰è£…æ—¶ä»…ä»…ä¼šå¯¹ ä¸»dex åšç¼–è¯‘ä¼˜åŒ–ï¼Œç„¶åå¯åŠ¨çš„æ—¶å€™ç›´æ¥åŠ è½½ ä¸»dexã€‚å¦‚æœå¿…è¦çš„ç±»è¢«æ•£è½åˆ°å…¶ä»–æœªåŠ è½½çš„dexä¸­ï¼Œåˆ™ä¼šå‡ºç°crashã€‚ä¹Ÿå°±æ˜¯å¼€å¤´æ‰€è¯´çš„   `java.lang.NoClassDefFoundError`ã€‚


> å…³äºè¿™ä¸ªexception å’Œ â€œjava.lang.ClassNoFoundErrorâ€ å¾ˆåƒï¼Œä½†æ˜¯æœ‰æ¯”è¾ƒå¤§çš„åŒºåˆ«ã€‚åè€…åœ¨ Androidä¸­å¸¸è§äºæ··æ·†å¼•èµ·ç±»æ— æ³•æ‰¾åˆ°æ‰€è‡´ã€‚


### å¯»æ‰¾è§£å†³æ–¹æ¡ˆ

æ˜ç™½äº†ä¸Šè¿°çš„æŠ€æœ¯èƒŒæ™¯ä¹‹åï¼Œå°±å¯ä»¥æƒ³åŠæ³•å‡å°‘ä¸»dexé‡Œé¢çš„ç±»ï¼ŒåŒæ—¶ç¡®ä¿åº”ç”¨èƒ½å¤Ÿæ­£å¸¸å¯åŠ¨ã€‚

ä½†æ˜¯å®˜æ–¹åªå‘Šè¯‰æˆ‘ä»¬ â€œå¦‚ä½• Keep ç±»æ¥æ–°å¢ä¸» dex é‡Œé¢çš„ç±»â€ï¼Œä½†æ˜¯æ²¡æœ‰å‘Šè¯‰æˆ‘ä»¬æ€ä¹ˆå‡å°‘å•Š ï¼å§æ§½äº†...

äºæ˜¯ä¹ï¼Œæˆ‘å¼€å§‹ Google + å„ç§github/issue æŸ¥çœ‹å…³äºå¦‚ä½•é¿å…ä¸» dex æ–¹æ³•çˆ†äº†çš„æ–¹æ¡ˆï¼Œå…¨éƒ½æ˜¯å‡ å¹´å‰çš„æ–‡ç« ï¼Œè¿™äº›æ–‡ç« å‡ºå¥‡ä¸€è‡´åœ°å‘Šè¯‰ä½ ã€‚

**â€œå°½é‡é¿å…åœ¨applicationä¸­å¼•ç”¨å¤ªå¤šç¬¬ä¸‰æ–¹å¼€æºåº“æˆ–è€…é¿å…ä¸ºäº†ä¸€äº›ç®€å•çš„åŠŸèƒ½è€Œå¼•å…¥ä¸€ä¸ªè¾ƒå¤§çš„åº“â€**

**â€œå››å¤§ç»„ä»¶ä¼šè¢«æ‰“åŒ…è¿› classes.dexâ€**


é¦–å…ˆæˆ‘è§‰å¾—å¾ˆæ— å¥ˆï¼Œé¦–å…ˆæˆ‘æ— æ³•çŸ¥é“æ„å»ºç³»ç»Ÿæ˜¯å¦‚ä½•å°†æ‰€è°“çš„ â€œå››å¤§ç»„ä»¶â€ æ‰“åŒ…è¿› classes.dexï¼Œæ— ä»è€ƒè¯ã€‚å…¶æ¬¡åœ¨ æœ¬æ¬¡ç‰ˆæœ¬ feature å·²ç»éªŒæ”¶å®Œæ¯•ä¹‹ä¸‹æˆ‘æ— æ³•ç›´æ¥å¯¹å¯åŠ¨çš„ä¾èµ–æ ‘è¿›è¡Œè°ƒæ•´ï¼Œè€Œä¸”ä¸šåŠ¡è¿­ä»£äº†å¾ˆä¹…ï¼Œç§»é™¤æˆ–è€…ç§»åŠ¨ä¸€ä¸ªå¯åŠ¨ä¾èµ–æ˜¯æ¯”è¾ƒå¤§çš„æ”¹åŠ¨ï¼Œé£é™©å¤ªå¤§äº†ã€‚ 

æˆ‘éå¸¸åŠªåŠ›åœ°ä¼˜åŒ–ï¼Œå†è·‘ä¸€ä¸‹ã€‚

```
D8: Cannot fit requested classes in the main-dex file (# methods:87463 > 65536 ; # fields: 74531 > 65536)
```

æ­¤æ—¶çš„æˆ‘æ˜¯éå¸¸ç»æœ›çš„ï¼ŒæŒ‰ç…§è¿™æ ·ä¼˜åŒ–ä¸å¯èƒ½é™ä½åˆ° 65536 ä»¥ä¸‹ã€‚ 

åœ¨è¿™é‡Œï¼Œæˆ‘èŠ±è´¹äº†å¾ˆå¤šæ—¶é—´åœ¨å°è¯•ç½‘ä¸Šæ‰€è¯´çš„å„ç§æ–¹æ¡ˆã€‚ æˆ‘å¾ˆéš¾ç”¨ â€œæµªè´¹â€ æ¥æè¿°å¯¹è¿™æ®µæ—¶é—´çš„ä½¿ç”¨ï¼Œå› ä¸ºå¦‚æœä¸æ˜¯è¿™æ ·ï¼Œæˆ‘å¯èƒ½ä¸ä¼šæ„è¯†åˆ°å¯¹å¾…è¿™ç±»é—®é¢˜ä¸Šæˆ‘çš„åšæ³•å¯èƒ½æ˜¯é”™è¯¯çš„ï¼Œå¹¶æŒ‡å¯¼æˆ‘ä»¥ååº”è¯¥è¿™æ ·åšã€‚

### â€œè¢«è¿«â€å•ƒä¸‹æºç 

æ—¢ç„¶æ˜¯ä» .class åˆ°ç”Ÿæˆ .dex ç¯èŠ‚å‡ºç°äº†é—®é¢˜ï¼Œé‚£å°±åªèƒ½ä»æ„å»ºæµç¨‹ä¸­è¯¥ç¯èŠ‚åˆ‡å…¥å»ç†Ÿæ‚‰ã€‚ é¡¹ç›®ç”¨çš„æ˜¯ AGP3.4.1 ç‰ˆæœ¬ï¼Œå¼€å§‹ä» **Transform** æ–¹å‘å»å°è¯•è§£æƒ‘ï¼šä» [gradle æºç ](https://android.googlesource.com/platform/tools/base/+/refs/tags/gradle_3.4.0/) ä¸­å°è¯•è·Ÿè¸ªå¹¶æ‰¾åˆ°ä¸€ä¸‹é—®é¢˜çš„ç­”æ¡ˆã€‚

1.  å¤„ç†åˆ†åŒ…çš„ Transform æ˜¯å“ªä¸ªï¼Œä¸»è¦åšäº†ä»€ä¹ˆ
2. å½±å“ maindexlist æœ€ç»ˆçš„ keep é€»è¾‘æ˜¯æ€ä¹ˆç¡®å®šçš„ ï¼Ÿ æ„å»ºç³»ç»Ÿæœ¬èº« keep äº†å“ªäº›ï¼Œå¼€å‘è€…å¯ä»¥ keep å“ªäº›ï¼Ÿ
3. ä»ä¸Šæ¸¸è¾“å…¥ä¸­æ¥å—çš„ clasee æ˜¯æ€ä¹ˆæ ¹æ® kepp é€»è¾‘è¿›è¡Œè¿‡æ»¤çš„
4. maindexlist æ–‡ä»¶æ˜¯ä»€ä¹ˆæ—¶å€™ç”Ÿæˆçš„ï¼Œåœ¨å“ªé‡Œç”Ÿæˆã€‚

è·Ÿæºç æ¯”è¾ƒç—›è‹¦ï¼Œç‰¹åˆ«æ˜¯ gradle æºç ä¸æ”¯æŒè·³è½¬åªèƒ½ä¸€ä¸ªä¸€ä¸ªç±»æŸ¥ï¼Œæœ‰äº›é€»è¾‘è¦çœ‹ä¸Šå››äº”éã€‚ä¸‹é¢æµç¨‹åªåˆ—å‡ºæ ¸å¿ƒæ­¥éª¤åŠæ–¹æ³•ã€‚

#### å¯»æ‰¾åˆ†åŒ… Transform

åœ¨åº”ç”¨æ„å»ºæµç¨‹ä¸­ï¼Œä¼šç»å† â€œè¯„ä¼°â€ é˜¶æ®µã€‚å½“ apply â€œcom.android.applicationâ€ æ’ä»¶ä¹‹åï¼Œè¯„ä¼°å‰åä¼šç»å†ä»¥ä¸‹æµç¨‹

1. com.android.build.gradle.BasePlugin#apply()
2. com.android.build.gradle.BasePlugin#basePluginApply()
3. com.android.build.gradle.BasePlugin#createTasks()
4. com.android.build.gradle.BasePlugin#createAndroidTasks()
5. **com.android.build.gradle.internal.VariantManager#createAndroidTasks(**ï¼‰ //é‡ç‚¹å…³æ³¨ä¸€
6. com.android.build.gradle.internal.VariantManager#createTasksForVariantData()
7. com.android.build.gradle.internal.ApplicationTaskManager#createTasksForVariantScope()  
8. com.android.build.gradle.internal.ApplicationTaskManager#addCompileTask() 
9. **com.android.build.gradle.internal.TaskManager#createPostCompilationTasks()** //é‡ç‚¹å…³æ³¨äºŒ
10. com.android.build.gradle.internal.pipeline.TransformManager#addTransform() 


ä¸Šè¿°æµç¨‹æœ‰ä¸¤ä¸ªç‚¹ç•™æ„ï¼š

1. çŸ¥é“ `VariantManager#createAndroidTasks` å¼€å§‹æ„å»º Android tasks
2. `TaskManager#createPostCompilationTasks()` ä¸ºæŸä¸€ä¸ªæ„å»ºåœºæ™¯æ·»åŠ  taskï¼Œå…¶ä¸­åŒ…å«äº†æ”¯æŒ Multi-Dex çš„ task

Multi-Dex support æ ¸å¿ƒä»£ç å¦‚ä¸‹

```
D8MainDexListTransform multiDexTransform = new D8MainDexListTransform(variantScope);
transformManager.addTransform(taskFactory, variantScope, multiDexTransform,
        taskName -> {
            File mainDexListFile =
                    variantScope
                            .getArtifacts()
                            .appendArtifact(
                                    InternalArtifactType.LEGACY_MULTIDEX_MAIN_DEX_LIST,
                                    taskName,
                                    "mainDexList.txt");
            multiDexTransform.setMainDexListOutputFile(mainDexListFile);
        }, null, variantScope::addColdSwapBuildTask);
```

`transformManager#addTransform`  ä¸€å…±æœ‰6ä¸ªå‚æ•°

* ç¬¬ä¸‰ä¸ªä¸º multiDexTransform å¯¹è±¡
* ç¬¬å››ä¸ªä¸º é¢„é…ç½®çš„ä»»åŠ¡ï¼Œç”¨äºç”Ÿæˆ mainDexList.txt çš„ actionï¼Œå…¶å®å°±æ˜¯ä¸ºäº†å»¶è¿Ÿåˆ›å»ºä»»åŠ¡çš„ï¼Œç”¨äºè®¾ç½® mainDexList.txt æ–‡ä»¶è·¯å¾„ã€‚

åˆ°è¿™é‡Œï¼Œæœ‰ç‚¹å¤´ç»ªäº†ã€‚

#### D8MainDexListTransform åšäº†ä»€ä¹ˆï¼Ÿ

 [D8MainDexListTransform](https://android.googlesource.com/platform/tools/base/+/refs/tags/gradle_3.4.0/build-system/gradle-core/src/main/java/com/android/build/gradle/internal/transforms/D8MainDexListTransform.kt) çš„æ„é€ å™¨å‚æ•°å¾ˆå…³é”®ã€‚

```
class D8MainDexListTransform(
        private val manifestProguardRules: BuildableArtifact,
        private val userProguardRules: Path? = null,
        private val userClasses: Path? = null,
        private val includeDynamicFeatures: Boolean = false,
        private val bootClasspath: Supplier<List<Path>>,
        private val messageReceiver: MessageReceiver) : Transform(), MainDexListWriter {}
```

1. manifestProguardRules ä¸º aapt æ··æ·†è§„åˆ™ï¼Œç¼–è¯‘æ—¶äº§ç”Ÿåœ¨ `build/intermediates/legacy_multidex_appt_derived_proguard_rules` ç›®å½•ä¸‹çš„ manifest_keep.txt
2. userProguardRules ä¸ºé¡¹ç›® multiDexKeepProguard ç”³æ˜çš„ keep è§„åˆ™
3. userClasses ä¸ºé¡¹ç›® multiDexKeepFile ç”³æ˜çš„ keep class 

è¿™ä¸‰ä»½æ–‡ä»¶éƒ½ä¼šå½±å“æœ€ç»ˆå†³å®šé‚£äº› class ä¼šè¢«æ‰“åˆ° clesses.dex ä¸­ï¼Œé€»è¾‘åœ¨ `transform()` é‡Œé¢:

```
override fun transform(invocation: TransformInvocation) {
    try {
        val inputs = getByInputType(invocation)
        val programFiles = inputs[ProguardInput.INPUT_JAR]!!
        val libraryFiles = inputs[ProguardInput.LIBRARY_JAR]!! + bootClasspath.get()
         // 1 å¤„
        val proguardRules =listOfNotNull(manifestProguardRules.singleFile().toPath(), userProguardRules)
        val mainDexClasses = mutableSetOf<String>()
        //  2 å¤„
        mainDexClasses.addAll(
            D8MainDexList.generate(
                getPlatformRules(),
                proguardRules,
                programFiles,
                libraryFiles,
                messageReceiver
            )
        )
        // 3 å¤„
        if (userClasses != null) {
            mainDexClasses.addAll(Files.readAllLines(userClasses))
        }
        Files.deleteIfExists(outputMainDexList)
        // 4å¤„
        Files.write(outputMainDexList, mainDexClasses)
    } catch (e: D8MainDexList.MainDexListException) {
        throw TransformException("Error while generating the main dex list:${System.lineSeparator()}${e.message}", e)
    }
}
```

1.  ç¬¬ä¸€å¤„ä»£ç æ‹¿åˆ° multiDexKeepProguard keep è§„åˆ™.
2. ç¬¬äºŒå¤„ä»£ç ä½¿ç”¨ `D8MainDexList#generate` ç”Ÿæˆæ‰€æœ‰éœ€è¦ keep åœ¨ classes.dex çš„ class é›†åˆï¼Œ `getPlatformRules()` æ–¹æ³•ä¸­å¼ºå¼ºåˆ¶å†™æ­»äº†ä¸€äº›è§„åˆ™.

	```
	internal fun getPlatformRules(): List<String> = listOf(
	    "-keep public class * extends android.app.Instrumentation {\n"
	            + "  <init>(); \n"
	            + "  void onCreate(...);\n"
	            + "  android.app.Application newApplication(...);\n"
	            + "  void callApplicationOnCreate(android.app.Application);\n"
	            + "  Z onException(java.lang.Object, java.lang.Throwable);\n"
	            + "}",
	    "-keep public class * extends android.app.Application { "
	            + "  <init>();\n"
	            + "  void attachBaseContext(android.content.Context);\n"
	            + "}",
	    "-keep public class * extends android.app.backup.BackupAgent { <init>(); }",
	    "-keep public class * implements java.lang.annotation.Annotation { *;}",
	    "-keep public class * extends android.test.InstrumentationTestCase { <init>(); }"
	)
	```
3. ç¬¬ä¸‰å¤„ä»£ç æŠŠ multiDexKeepFile ç”³æ˜éœ€è¦ä¿ç•™çš„ class æ·»åŠ åˆ° 2 æ­¥éª¤ç”Ÿæˆçš„é›†åˆä¸­
4. ç¬¬å››å‡ºä»£ç æœ€ç»ˆè¾“å…¥åˆ° outputMainDexList ï¼Œè¿™ä¸ªæ–‡ä»¶å°±æ˜¯åœ¨æ·»åŠ  D8MainDexListTransform çš„æ—¶å€™é¢„è®¾ç½®çš„ mainDexList.txtï¼Œä¿å­˜åœ¨ `build/intermediates/legacy_multidex_main_dex_list` ç›®å½•ä¸‹ã€‚

åˆ°è¿™é‡Œï¼Œæƒ³åŠæ³•åœ¨å‹¾ä½ `mainDexList.txt`ï¼Œ åœ¨çœŸæ­£æ‰“åŒ… classes.dex ä¹‹å‰ä¿®æ”¹æ–‡ä»¶æ—¶åº”è¯¥èƒ½ä¿è¯æ–¹æ³•æ•°æ§åˆ¶åœ¨ 65536 ä¹‹ä¸‹çš„ã€‚æˆ‘ä»¬é¡¹ç›®ä¸­ä½¿ç”¨äº† tinkerï¼Œ tinker ä¹Ÿ keep äº†ä¸€äº›ç±»åˆ° classes.dexã€‚ä» multiDexKeepProguard/multiDexKeepFile æ‰‹æ®µä¸Šä¸å­˜åœ¨æ“ä½œç©ºé—´ï¼Œå› ä¸ºè¿™äº›æ˜¯ä¸šåŠ¡ç¡¬è¦æ±‚çš„é€»è¾‘ã€‚åªèƒ½çœ‹ç¼–è¯‘ä¹‹åç”Ÿæˆçš„ mainDexList.txtï¼Œç„¶åå‡­å€Ÿç»éªŒå»æ‰ä¸€äº›çœ‹èµ·æ¥å¯èƒ½ â€œå‰æœŸä¸éœ€è¦â€ çš„ classï¼Œä½†ç¨å¾®ä¸æ…éƒ½æœ‰å¯èƒ½å¯¼è‡´ crash äº§ç”Ÿã€‚

#### å¯»æ‰¾æ˜ç¡®çš„ â€œKeepâ€ é“¾

å¸Œæœ›èƒ½ä»ä»£ç é€»è¾‘ä¸Šå¾—åˆ° â€œæ›´ä¸ºæ˜ç¡®çš„æŒ‡å¯¼â€ï¼Œå°±å¾—äº†è§£ä¸‹ä¸ºå•¥ D8 æ„å»ºæµç¨‹ï¼Œ ä¸ºå•¥ keep äº†é‚£ä¹ˆå¤šç±»ï¼Œè¿™äº›ç±»æ˜¯å¦å­˜åœ¨åˆ å‡çš„ç©ºé—´ã€‚

ä½†æ˜¯æˆ‘åœ¨ gradle æºç ä¸­å¹¶æ²¡æœ‰æ‰¾åˆ°  **[D8MainDexList.java](https://android.googlesource.com/platform/tools/base/+/refs/tags/gradle_3.4.0/build-system/builder/src/main/java/com/android/builder/multidex/D8MainDexList.java)**#generate çš„ç›¸å…³ä¿¡æ¯ï¼Œå®ƒè¢«æ”¾åˆ° `build-system`  çš„å¦ä¸€ä¸ªç›®å½•ä¸­ï¼Œæ ¸å¿ƒé€»è¾‘å¦‚ä¸‹ã€‚

```
public static List<String> generate(
        @NonNull List<String> mainDexRules,		
        @NonNull List<Path> mainDexRulesFiles,
        @NonNull Collection<Path> programFiles,
        @NonNull Collection<Path> libraryFiles,
        @NonNull MessageReceiver messageReceiver)
        throws MainDexListException {
    D8DiagnosticsHandler d8DiagnosticsHandler =
            new InterceptingDiagnosticsHandler(messageReceiver);
    try {
        GenerateMainDexListCommand.Builder command =
                GenerateMainDexListCommand.builder(d8DiagnosticsHandler)
                        .addMainDexRules(mainDexRules, Origin.unknown()) //d8å¼ºåˆ¶å†™æ­»çš„è§„åˆ™
                        .addMainDexRulesFiles(mainDexRulesFiles) //å¼€å‘è€…é€šè¿‡ multiDexKeepProguard æ·»åŠ çš„è§„åˆ™
                        .addLibraryFiles(libraryFiles);
        for (Path program : programFiles) {
            if (Files.isRegularFile(program)) {
                command.addProgramFiles(program);
            } else {
                try (Stream<Path> classFiles = Files.walk(program)) {
                    List<Path> allClasses = classFiles
                            .filter(p -> p.toString().endsWith(SdkConstants.DOT_CLASS))
                            .collect(Collectors.toList());
                    command.addProgramFiles(allClasses);
                }
            }
        }
          //æœ€ç»ˆè°ƒç”¨ GenerateMainDexList#run
        return ImmutableList.copyOf(
                GenerateMainDexList.run(command.build(), ForkJoinPool.commonPool()));
    } catch (Exception e) {
        throw getExceptionToRethrow(e, d8DiagnosticsHandler);
    }
}
```
ä¸Šè¿°æœ€ç»ˆé€šè¿‡æ„å»º `GenerateMainDexListCommand` å¯¹è±¡å¹¶ä¼ é€’ç»™  **GenerateMainDexList** æ‰§è¡Œã€‚ è¿™ä¸¤ä¸ªç±»åœ¨æˆ‘ä»¬æœ¬åœ° AndroidSdk é‡Œï¼Œè·¯å¾„ä¸º `{AndroidSdk}/build-tools/{buildToolsVersion}/lib/d8.jar` ä¸­ï¼Œå¯é€šè¿‡ **JD_GUI** å·¥å…·æŸ¥çœ‹ã€‚

*GenerateMainDexListCommandBuilder#build()*  åœ¨æ„å»ºå¯¹è±¡çš„æ—¶å€™åšäº†ä»¥ä¸‹å·¥ä½œï¼š

1.  æ„å»º **DexItemFactory** å·¥å‚å¯¹è±¡ï¼Œç”¨äºæ„å»º DexStringï¼ŒDexMethod ç­‰ç›¸å…³ dex ä¿¡æ¯
2.  é¢„å¤„ç†äº†è§„åˆ™æ–‡ä»¶ï¼Œæ¯”å¦‚åˆ é™¤ â€œ#â€ æ³¨è§£ç›¸å…³ç­‰ï¼Œè§£ææˆ **ProguardConfigurationRule** å¯¹è±¡é›†
3.  æ„å»º **AndroidApp** å¯¹è±¡ï¼Œç”¨äºè®°å½•ç¨‹åºèµ„æºçš„ä¿¡æ¯ï¼Œæ¯”å¦‚ dexClassï¼ŒlibraryResource ç­‰ç­‰

æœ€ç»ˆä¼ é€’ **AndroidApp**  å¯¹è±¡ ç»™ *GenerateMainDexList#run()* è°ƒç”¨ã€‚

```
private List<String> run(AndroidApp app, ExecutorService executor) throws IOException, ExecutionException {
    // æ­¥éª¤ä¸€
	DirectMappedDexApplication directMappedDexApplication =
		 (new ApplicationReader(app, this.options, 	this.timing)).read(executor).toDirect();
	// æ­¥éª¤äºŒ
	AppInfoWithSubtyping appInfo = new AppInfoWithSubtyping((DexApplication)directMappedDexApplication);
	// æ­¥éª¤ä¸‰
	RootSetBuilder.RootSet mainDexRootSet = 
		(new RootSetBuilder((DexApplication)directMappedDexApplication, (AppInfo)appInfo, (List)this.options.mainDexKeepRules, this.options)).run(executor);
	Enqueuer enqueuer = new Enqueuer(appInfo, this.options, true);
	Enqueuer.AppInfoWithLiveness mainDexAppInfo = enqueuer.traceMainDex(mainDexRootSet, this.timing);
	// æ­¥éª¤å››
	Set<DexType> mainDexClasses = (new MainDexListBuilder(new HashSet(mainDexAppInfo.liveTypes), 		(DexApplication)directMappedDexApplication)).run();
	List<String> result = (List<String>)mainDexClasses.stream().map(c -> c.toSourceString().replace('.', '/') + 			".class").sorted().collect(Collectors.toList());
	if (this.options.mainDexListConsumer != null)
  		this.options.mainDexListConsumer.accept(String.join("\n", (Iterable)result), (DiagnosticsHandler)this.options.reporter); 
	if (mainDexRootSet.reasonAsked.size() > 0) {
		TreePruner pruner = new TreePruner((DexApplication)directMappedDexApplication, mainDexAppInfo.withLiveness(), this.options);
		DexApplication dexApplication = pruner.run();
		ReasonPrinter reasonPrinter = enqueuer.getReasonPrinter(mainDexRootSet.reasonAsked);
		reasonPrinter.run(dexApplication);
	} 
	return result;
}
```

* æ­¥éª¤ä¸€ï¼Œæ„å»ºäº† *ApplicationReader* å¯¹è±¡ï¼Œé˜»å¡ç­‰å¾… *read()* æ–¹æ³•è¯»å–äº†æ‰€æœ‰ç¨‹åºçš„èµ„æºï¼Œå¦‚æœæ˜¯å­˜åœ¨ .dex èµ„æºï¼Œåˆ™å½’ç±»åˆ° dex ç±»å‹ï¼›å¦‚æœå­˜åœ¨ class ç±»å‹ï¼Œåˆ™å½’åˆ° class ç±»å‹ï¼ˆä½†æ˜¯è¿‡æ»¤äº† module-info.class çš„æ–‡ä»¶ï¼‰ã€‚è¿™éƒ¨åˆ†é€»è¾‘å¯åœ¨ `com.android.tools.r8.util.FilteredArchiveProgramResourceProvider` æŸ¥çœ‹ã€‚dex ç±»å‹ä½¿ç”¨ dex æ ¼å¼è§£æï¼Œclass ç±»å‹ä½¿ç”¨å­—èŠ‚ç æ ¼å¼è§£æä¹‹åä¿å­˜åˆ° *directMappedDexApplication*  å¯¹è±¡ä¸­ã€‚
* æ­¥éª¤äºŒ **AppInfoWithSubtyping** è¯»å–äº† *directMappedDexApplication*ï¼Œè®¡ç®—å¹¶è®¾ç½®ç±»çš„super/sub å…³ç³»ã€‚
* æ­¥éª¤ä¸‰ æŠŠæ‰€æœ‰æ”¶é›†åˆ°çš„ç±»ä¿¡æ¯åŠç±»çš„super/sub å…³ç³»ï¼ŒåŠ keep çš„è§„åˆ™ä¼ é€’ç»™ RootSetBuilder ç”¨äºè®¡ç®— **Root** é›†åˆï¼Œè¯¥é›†åˆå†³å®šå“ªäº›ç±»å°†æœ€ç»ˆè¢« keep åˆ° classes.dex é‡Œé¢ã€‚ç»è¿‡åŒ¹é…æ··æ·†ä¹‹åè·å¾— **Root** é›†åˆä¹‹åï¼Œè°ƒç”¨ *run()* è¿›è¡Œå‘ä¸‹æ£€ç´¢ã€‚ä¸»è¦æ˜¯è®¡ç®— **Root**  é›†åˆå†…çš„ class çš„ä¾èµ–åŠä½¿ç”¨æšä¸¾ä½œä¸ºè¿è¡Œæ—¶æ³¨è§£ç±»ã€‚
* æ­¥éª¤å›› æ ¹æ® **Root** é›†åˆï¼ŒæŒ‰ç…§ä»¥ä¸‹ä¸¤ä¸ªæ–¹æ³•é¡ºåºæ£€ç´¢å¾—åˆ° **mainDexClass** é›†åˆï¼Œæ–¹æ³•é€»è¾‘å¦‚ä¸‹ã€‚
	1. `traceMainDexDirectDependencies()`æ–¹æ³• 
		* æ·»åŠ  Root èŠ‚ç‚¹ classï¼Œæ·»åŠ å…¶æ‰€æœ‰çˆ¶ç±»åŠæ¥å£ï¼›
		* æ·»åŠ  Root èŠ‚ç‚¹ class ä¸­é™æ€å˜é‡ï¼Œæˆå‘˜å˜é‡ï¼›
		* æ·»åŠ  Root èŠ‚ç‚¹ class ä¸­çš„æ–¹æ³•çš„å‚æ•°ç±»å‹çš„ classï¼Œè¿”å›å€¼ç±»å‹å¯¹åº”çš„ classï¼›
		* æ”¶é›† Root èŠ‚ç‚¹ class çš„æ³¨è§£ã€‚
	2. `traceRuntimeAnnotationsWithEnumForMainDex()` æ–¹æ³•
		*  æ‰€æœ‰ç±»ä¸­ï¼Œå¦‚æœ class æ˜¯æ³¨è§£ç±»å‹ä¸”ä½¿ç”¨æšä¸¾ç±»ï¼Œåˆ™æ”¶é›†ï¼›
		*  æ‰€æœ‰ç±»ä¸­ï¼Œå¦‚æœ class ä½¿ç”¨äº†ä¸Šä¸€æ¡è§„åˆ™çš„æšä¸¾ç±»ä¸”æšä¸¾å¯è§ï¼Œåˆ™ä¹Ÿæ”¶é›†ã€‚


å› æ­¤ï¼Œæœ€ç»ˆç”Ÿæˆçš„é›†åˆï¼Œä¼šåœ¨ **[D8MainDexListTransform](https://android.googlesource.com/platform/tools/base/+/refs/tags/gradle_3.4.0/build-system/gradle-core/src/main/java/com/android/build/gradle/internal/transforms/D8MainDexListTransform.kt)**#transform ä¸­åˆå¹¶å­˜åœ¨çš„ multiDexKeepFile è§„åˆ™ï¼Œå¹¶æœ€ç»ˆå†™åˆ° `build/intermediates/legacy_mltidex_main_dex_list/` ç›®å½•ä¸‹çš„ `maindexlist.txt` æ–‡ä»¶ã€‚

### å°è¯•æ–°æ–¹æ¡ˆ

é‚£ä¹ˆ **D8MainDexListTransform** èƒ½å¤Ÿè¢«æˆ‘å‹¾ä½ä½¿ç”¨å‘¢ï¼Ÿ å½“ç„¶å¯ä»¥ã€‚ æ‰¾åˆ° **D8MainDexListTransform** å¯¹åº”çš„ **Task**ï¼Œå¯ä»¥é€šè¿‡ *project.tasks.findByName* æ¥è·å– *task* å¯¹è±¡ï¼Œç„¶ååœ¨ gradle è„šæœ¬ä¸­ç›‘å¬è¿™ä¸ª *task* çš„æ‰§è¡Œï¼Œåœ¨ task ç»“æŸä¹‹åå¹¶è¿”å›ç»“æœä¹‹å‰æ’å…¥æˆ‘ä»¬è‡ªå®šä¹‰çš„ taskï¼Œå¯é€šè¿‡ *finalizeBy* æ–¹æ³•å®ç°ã€‚

è€Œ D8MainDexListTransform å¯¹åº” Task çš„åå­—çš„é€»è¾‘é€šè¿‡é˜…è¯» [TransformManager](https://android.googlesource.com/platform/tools/base/+/refs/tags/gradle_3.4.0/build-system/gradle-core/src/main/java/com/android/build/gradle/internal/pipeline/TransformManager.java)#getTaskNamePrefix å¯æ¨æ–­ã€‚

æŠŠä¸Šè¿°æ‰€æœ‰é€»è¾‘å°è£…æˆä¸€ä¸ª gradle è„šæœ¬å¹¶åœ¨ application æ¨¡å—ä¸­ apply å°±è¡Œäº†ã€‚

```
project.afterEvaluate {

    println "handle main-dex by userï¼Œstart..."
    if (android.defaultConfig.minSdkVersion.getApiLevel() >= 21) {
        return
    }
    println "main-dexï¼ŒminSdkVersion is ${android.defaultConfig.minSdkVersion.getApiLevel()}"
    android.applicationVariants.all { variant ->

        def variantName = variant.name.capitalize()
        def multidexTask = project.tasks.findByName("transformClassesWithMultidexlistFor${variantName}")
        def exist = multidexTask != null
        println "main-dex multidexTask(transformClassesWithMultidexlistFor${variantName}) exist: ${exist}"
        
        if (exist) {
            def replaceTask = createReplaceMainDexListTask(variant);
            multidexTask.finalizedBy replaceTask
        }
    }
}

def createReplaceMainDexListTask(variant) {
    def variantName = variant.name.capitalize()

    return task("replace${variantName}MainDexClassList").doLast {

        //ä»ä¸»dexç§»é™¤çš„åˆ—è¡¨
        def excludeClassList = []
        File excludeClassFile = new File("{å­˜æ”¾å‰”é™¤è§„åˆ™çš„è·¯å¾„}/main_dex_exclude_class.txt")
        println "${project.projectDir}/main_dex_exclude_class.txt exist: ${excludeClassFile.exists()}"
        if (excludeClassFile.exists()) {
            excludeClassFile.eachLine { line ->
                if (!line.trim().isEmpty() && !line.startsWith("#")) {
                    excludeClassList.add(line.trim())
                }
            }
            excludeClassList.unique()
        }
        def mainDexList = []
        File mainDexFile = new File("${project.buildDir}/intermediates/legacy_multidex_main_dex_list/${variant.dirName}/transformClassesWithMultidexlistFor${variantName}/maindexlist.txt")
        println "${project.buildDir}/intermediates/legacy_multidex_main_dex_list/${variant.dirName}/transformClassesWithMultidexlistFor${variantName}/maindexlist.txt exist : ${mainDexFile.exists()}"
        //å†æ¬¡åˆ¤æ–­å…¼å®¹ linux/mac ç¯å¢ƒè·å–
        if(!mainDexFile.exists()){
            mainDexFile = new File("${project.buildDir}/intermediates/legacy_multidex_main_dex_list/${variant.dirName}/transformClassesWithMultidexlistFor${variantName}/mainDexList.txt")
            println "${project.buildDir}/intermediates/legacy_multidex_main_dex_list/${variant.dirName}/transformClassesWithMultidexlistFor${variantName}/mainDexList.txt exist : ${mainDexFile.exists()}"
        }
        if (mainDexFile.exists()) {
            mainDexFile.eachLine { line ->
                if (!line.isEmpty()) {
                    mainDexList.add(line.trim())
                }
            }
            mainDexList.unique()
            if (!excludeClassList.isEmpty()) {
                def newMainDexList = mainDexList.findResults { mainDexItem ->
                    def isKeepMainDexItem = true
                    for (excludeClassItem in excludeClassList) {
                        if (mainDexItem.contains(excludeClassItem)) {
                            isKeepMainDexItem = false
                            break
                        }
                    }
                    if (isKeepMainDexItem) mainDexItem else null
                }
                if (newMainDexList.size() < mainDexList.size()) {
                    mainDexFile.delete()
                    mainDexFile.createNewFile()
                    mainDexFile.withWriterAppend { writer ->
                        newMainDexList.each {
                            writer << it << '\n'
                            writer.flush()
                        }
                    }
                }
            }
        }
    }
}
```
è€Œ `main_dex_exclude_class.txt`  çš„å†…å®¹å¾ˆç®€å•ï¼Œè§„åˆ™å’Œ multiDexKeepFile æ˜¯ä¸€æ ·çš„ï¼Œæ¯”å¦‚ï¼š

```
com/facebook/fresco
com/android/activity/BaseLifeActivity.class
...
```
è¿™æ ·å°±å¯ä»¥å•¦ï½ å¦‚æœä½ æ‰¾ä¸åˆ° D8MainDexListTransform å¯¹åº”çš„ Taskï¼Œé‚£ä½ åº”è¯¥æ˜¯ç”¨äº† r8 ï¼Œr8 ä¼šåˆå¹¶ mainDexList çš„æ„å»ºæµç¨‹åˆ°æ–°çš„ Taskï¼Œä½ å¯ä»¥é€‰æ‹©å…³é—­ r8 æˆ–è€…å¯»æ‰¾æ–°çš„ hook ç‚¹ï¼Œæ€è·¯æ˜¯ä¸€æ ·çš„ã€‚

**â€œä»€ä¹ˆï¼Œä½ è®²äº†ä¸€éæµç¨‹ï¼Œä½†æ˜¯è¿˜æ˜¯æ²¡æœ‰è¯´å“ªäº›å¯ä»¥åˆ   â€**

**â€œå…¶å®ï¼Œé™¤äº† D8 å¼ºåˆ¶ keep ä½çš„ç±»å’Œ contentProvider, å…¶ä»–éƒ½å¯ä»¥åˆ ã€‚â€**

**â€œä½†æ˜¯æˆ‘çœ‹åˆ°ç½‘ä¸Šå¾ˆå¤šæ–‡ç« è¯´ï¼Œå››å¤§ç»„ä»¶éƒ½è¦ keep ä½å“¦â€**

**â€œå»ºè®®ä»¥æˆ‘ä¸ºå‡†ã€‚â€**

å½“ç„¶ï¼Œæˆ‘å·²ç»è¯•è¿‡äº†ï¼Œä½ æŠŠå…¥å£ Activity åˆ é™¤ï¼Œä¹Ÿåªæ˜¯æ…¢ä¸€äº›è€Œå·²ï¼Œåªæ˜¯ä¸å»ºè®®ç½¢äº†ã€‚æˆ–è€…ä½ å¯ä»¥é€‰æ‹©æŠŠäºŒçº§é¡µé¢å…¨éƒ¨ç§»é™¤å‡ºå»ï¼Œè¿™æ ·å¯èƒ½ä¼šå¤§å¤§å‡å°‘  classes.dex çš„æ–¹æ³•æ•°ã€‚

**æœ€ç»ˆæ•ˆæœï¼š methods: 87855 > 49386ã€‚**

ä¸Šè¿°åˆ†æå­˜åœ¨é”™è¯¯æ¬¢è¿æŒ‡æ­£æˆ–æœ‰æ›´å¥½çš„å¤„ç†å»ºè®®ï¼Œæ¬¢è¿è¯„è®ºç•™è¨€å“¦ã€‚ 

> è§£å†³é—®é¢˜å¾ˆç—›è‹¦ï¼Œé€¼ç€ä½ å»å¯»æ‰¾ç­”æ¡ˆï¼Œä½†è§£å†³ä¹‹åçœŸçš„çˆ½ã€‚





